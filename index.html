<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>DNA Complement Tetris</title>
<meta name="color-scheme" content="light dark" />
<style>
  :root { --ink:#111827; --muted:#6B7280; --chip:#F3F4F6; }
  html,body { height:100%; margin:0; overflow:hidden; } /* prevent page scrolling */
  body { font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; background:#fff; color:var(--ink); }
  .dna-badge{padding:4px 10px;border-radius:999px;font-weight:600;font-size:12px;background:var(--chip);color:var(--ink)}
  .dna-btn{border:none;border-radius:12px;padding:8px 12px;background:#111827;color:#fff;font-weight:700;font-size:12px;opacity:.92;cursor:pointer}
  .dna-btn[disabled]{opacity:.45;cursor:not-allowed;filter:grayscale(.4)}
  .dna-btn:active{transform:translateY(1px);opacity:1}
  #dna-tetris-root { width: min(1200px, 96vw); margin: 10px auto 24px; }
  .dna-canvas-wrap{
    position:relative;border-radius:16px;overflow:hidden;
    background:linear-gradient(180deg,#0B1021 0%,#101631 100%);
    box-shadow:0 10px 30px rgba(0,0,0,.15);
  }
  canvas{display:block;margin:0 auto}
  .level-pill{ padding:6px 14px;border-radius:999px;font-weight:800;
    background:#111827;color:#fff;font-size:14px;letter-spacing:.2px }
  .ov-actions{display:flex;gap:10px;justify-content:center;margin-top:12px;flex-wrap:wrap}
  .btn-secondary{background:#374151}
</style>
</head>
<body>

<!-- Game top instruction -->
<div style="text-align:center;font-size:18px;font-weight:700;color:#111827;margin:12px 0;">
  Win the game by translating all the DNA to the complete protein
</div>

<div id="dna-tetris-root">
  <div class="dna-hud" style="display:flex;justify-content:space-between;align-items:center;gap:12px;margin:8px 0;flex-wrap:wrap;padding:0 12px;">
    <strong style="font-size:14px;">DNA Complement Tetris</strong>

    <div class="dna-input-wrap" style="display:flex;gap:8px;align-items:center;flex:1 1 520px;min-width:280px;">
      <input id="dna-seq-input" type="text" inputmode="latin" autocomplete="off" spellcheck="false"
             placeholder="Paste DNA (A/T/C/G), then click Enter"
             style="flex:1; padding:8px 10px; border-radius:10px; border:1px solid #E5E7EB; font-size:13px;">
      <button id="dna-seq-start" class="dna-btn" style="font-weight:800;" disabled>Enter</button>
      <span id="dna-msg" style="font-size:12px;color:#6B7280;white-space:nowrap;">Only A/T/C/G • min 3 bases</span>
    </div>

    <div style="display:flex;gap:10px;align-items:center;">
      <span id="levelPill" class="level-pill">Level 1</span>
      <span id="dna-score" class="dna-badge">Score 0</span>
      <span id="dna-lives" class="dna-badge">❤❤❤</span>
    </div>
  </div>

  <div class="dna-canvas-wrap">
    <canvas id="dna-board" aria-label="DNA game canvas" role="img"></canvas>

    <!-- Bottom button controls removed -->

    <div id="dna-overlay" style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.5);">
      <div style="background:white;padding:16px;border-radius:12px;text-align:center;width:min(90%,520px);box-shadow:0 10px 20px rgba(0,0,0,.2);">
        <h3 id="dna-ov-title" style="margin:0 0 8px;font-size:18px;color:#111827;">Ready</h3>
        <p id="dna-ov-sub" style="margin:6px 0;font-size:13px;color:#374151;">
          Paste a DNA sequence and click <strong>Enter</strong> — or start with GFP.<br/>
          <em>A pairs with T, and C pairs with G.</em>
        </p>
        <div class="ov-actions">
          <button id="startGfpBtn" class="dna-btn">Start with GFP</button>
          <button id="startCustomBtn" class="dna-btn btn-secondary">Start with Custom</button>
        </div>
        <div style="display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin-top:12px;font-size:12px;">
          <span class="dna-badge">◀ ▶ move</span>
          <span class="dna-badge">▼ soft drop</span>
          <span class="dna-badge">⤓ hard drop</span>
          <span class="dna-badge">P pause / resume</span>
          <span class="dna-badge">R restart</span>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/* ===== DNA Complement Tetris – live AA counter, renamed "Tutorial", new card ===== */
(function(){
  try{
    const MOUNT_ID='dna-tetris-root';
    const BASES=['A','T','C','G'];
    const COMPL={A:'T',T:'A',C:'G',G:'C'};
    const COLORS={A:'#4F46E5',T:'#F59E0B',C:'#10B981',G:'#8B5CF6'};

    // GFP sequence (lowercase shown; uppercase used internally)
    const DEFAULT_SEQ_LOWER="atgcgtaaaggagaagaacttttcactggagttgtcccaattcttgttgaattagatggtgatgttaatgggcacaaattttctgtcagtggagagggtgaaggtgatgcaacatacggaaaacttacccttaaatttatttgcactactggaaaactacctgttccatggccaacacttgtcactactttcggttatggtgttcaatgctttgcgagatacccagatcatatgaaacagcatgactttttcaagagtgccatgcccgaaggttatgtacaggaaagaactatatttttcaaagatgacgggaactacaagacacgtgctgaagtcaagtttgaaggtgatacccttgttaatagaatcgagttaaaaggtattgattttaaagaagatggaaacattcttggacacaaattggaatacaactataactcacacaatgtatacatcatggcagacaaacaaaagaatggaatcaaagttaacttcaaaattagacacaacattgaagatggaagcgttcaactagcagaccattatcaacaaaatactccaattggcgatggccctgtccttttaccagacaaccattacctgtccacacaatctgccctttcgaaagatcccaacgaaaagagagatcacatggtccttcttgagtttgtaacagctgctgggattacacatggcatggatgaactatacaaataataa";
    const DEFAULT_SEQ = DEFAULT_SEQ_LOWER.toUpperCase();

    const CODON_TO_AA={TTT:'PHE',TTC:'PHE',TTA:'LEU',TTG:'LEU',CTT:'LEU',CTC:'LEU',CTA:'LEU',CTG:'LEU',ATT:'ILE',ATC:'ILE',ATA:'ILE',ATG:'MET',GTT:'VAL',GTC:'VAL',GTA:'VAL',GTG:'VAL',TCT:'SER',TCC:'SER',TCA:'SER',TCG:'SER',CCT:'PRO',CCC:'PRO',CCA:'PRO',CCG:'PRO',ACT:'THR',ACC:'THR',ACA:'THR',ACG:'THR',GCT:'ALA',GCC:'ALA',GCA:'ALA',GCG:'ALA',TAT:'TYR',TAC:'TYR',TAA:'STOP',TAG:'STOP',CAT:'HIS',CAC:'HIS',CAA:'GLN',CAG:'GLN',AAT:'ASN',AAC:'ASN',AAA:'LYS',AAG:'LYS',GAT:'ASP',GAC:'ASP',GAA:'GLU',GAG:'GLU',TGT:'CYS',TGC:'CYS',TGA:'STOP',TGG:'TRP',CGT:'ARG',CGC:'ARG',CGA:'ARG',CGG:'ARG',AGT:'SER',AGC:'SER',AGA:'ARG',AGG:'ARG',GGT:'GLY',GGC:'GLY',GGA:'GLY',GGG:'GLY'};
    const AA3_TO_1={PHE:'F',LEU:'L',ILE:'I',MET:'M',VAL:'V',SER:'S',PRO:'P',THR:'T',ALA:'A',TYR:'Y',STOP:'*',HIS:'H',GLN:'Q',ASN:'N',LYS:'K',ASP:'D',GLU:'E',CYS:'C',TRP:'W',ARG:'R',GLY:'G'};

    function ready(fn){document.readyState!=='loading'?fn():document.addEventListener('DOMContentLoaded',fn);}
    ready(function(){
      const host=document.getElementById(MOUNT_ID);
      const wrap=host.querySelector('.dna-canvas-wrap');
      const cvs=host.querySelector('#dna-board'); const ctx=cvs.getContext('2d');

      // HUD
      const scoreEl=host.querySelector('#dna-score');
      const levelPill=host.querySelector('#levelPill');
      const livesEl=host.querySelector('#dna-lives');
      const overlay=host.querySelector('#dna-overlay'); const ovTitle=host.querySelector('#dna-ov-title'); const ovSub=host.querySelector('#dna-ov-sub');
      const seqInput=host.querySelector('#dna-seq-input'); const startBtn=host.querySelector('#dna-seq-start'); const msgEl=host.querySelector('#dna-msg');
      const startGfpBtn=document.getElementById('startGfpBtn'); const startCustomBtn=document.getElementById('startCustomBtn');

      seqInput.value = DEFAULT_SEQ_LOWER;

      /* geometry */
      const COLS=12, ROWS=9;
      const BUILD_ROW=ROWS-2, TARGET_ROW=ROWS-1;
      const ROWS_PER_COL=20, MAX_AA_COLS=5;
      let dpi=Math.max(1, Math.floor(window.devicePixelRatio||1));
      let cell=0, labelPx=0, gridX0=0, leftPanelPx=0, rightPanelPx=0;

      /* state */
      let running=false, hasStarted=false, score=0, level=1, lives=3, fallInterval=560, lastStep=0;
      let masterSeq=DEFAULT_SEQ, seqIdx=0;
      let bottomRow=[], placedTop=Array(COLS).fill(null), filledCount=0;
      let processedAA=[], totalAAcount=Math.floor(masterSeq.length/3);
      let nextBase='A', piece={base:'A',x:(COLS/2)|0,y:-4}, pendingSpawn=false;
      let showGuide=true;

      overlay.style.display='flex'; ovTitle.textContent='Ready';
      ovSub.innerHTML='Paste a DNA sequence and click <strong>Enter</strong> — or start with GFP.<br><em>A pairs with T, and C pairs with G.</em>';

      /* helpers */
      function sanitizeDNA(s){return (s||'').toUpperCase().replace(/[^ATCG]/g,'');}
      function getSegment(start,len){const arr=[];const n=(masterSeq||'').length||1;for(let i=0;i<len;i++)arr.push(masterSeq[(start+i)%n]||'A');return arr;}
      function hasValidSlot(base){const want=COMPL[base];for(let c=0;c<COLS;c++)if(!placedTop[c]&&bottomRow[c]===want)return true;return false;}
      function pickValidBase(){const open=[];for(let c=0;c<COLS;c++)if(!placedTop[c])open.push(c);if(!open.length)return BASES[(Math.random()*BASES.length)|0];const col=open[(Math.random()*open.length)|0];const br=bottomRow[col];return Object.keys(COMPL).find(b=>COMPL[b]===br)||BASES[(Math.random()*BASES.length)|0];}
      function spawnPiece(){const base=(nextBase&&hasValidSlot(nextBase))?nextBase:pickValidBase(); nextBase=pickValidBase(); return {base,x:(COLS/2)|0,y:-4};}
      function sideTitleSize(){ return Math.max(12*dpi, Math.floor(cell*0.45)); } // unified side title font size

      function resize(){
        const viewportW = window.innerWidth, viewportH = window.innerHeight;
        const boxW = host.clientWidth || viewportW;
        const boxH = Math.max(480, Math.min(Math.round(viewportH*0.78), 1100));
        wrap.style.width = boxW + 'px';
        wrap.style.height = boxH + 'px';
        cvs.style.width = boxW + 'px';
        cvs.style.height = boxH + 'px';

        let cssCell = Math.floor(Math.min(boxW/COLS, (boxH-60)/(ROWS+1)));
        cssCell = Math.max(18, cssCell);
        function dims(cellGuess){
          const rTop=Math.max(10,Math.floor(cellGuess*0.28));
          const colWidth=2*rTop+10;
          const leftCss=Math.max(120, colWidth*MAX_AA_COLS+32);
          const rightCss=Math.max(260, Math.floor(cellGuess*5.2));
          const labelCss=Math.max(28,Math.round(Math.max(28,cellGuess*1.0)));
          const gridCssW=cellGuess*COLS, gridCssH=cellGuess*ROWS;
          return {leftCss,rightCss,labelCss,totalCssW:leftCss+gridCssW+rightCss,totalCssH:labelCss+gridCssH,cellGuess};
        }
        let d=dims(cssCell);
        const widthCell=Math.floor((boxW-(d.leftCss+d.rightCss))/COLS);
        const heightCell=Math.floor((boxH-d.labelCss)/ROWS);
        cssCell=Math.max(16, Math.min(widthCell, heightCell));
        d=dims(cssCell);

        cell=Math.floor(d.cellGuess*dpi);
        leftPanelPx=Math.floor(d.leftCss*dpi);
        rightPanelPx=Math.floor(d.rightCss*dpi);
        gridX0=leftPanelPx;
        labelPx=Math.floor(d.labelCss*dpi);
        cvs.width=Math.floor(d.totalCssW*dpi);
        cvs.height=Math.floor(d.totalCssH*dpi);
        draw();
      }
      window.addEventListener('resize', resize);

      /* drawing primitives */
      function roundRect(x,y,w,h,r){const rr=Math.min(r,w/2,h/2);ctx.beginPath();ctx.moveTo(x+rr,y);ctx.arcTo(x+w,y,x+w,y+h,rr);ctx.arcTo(x+w,y+h,x,y+h,rr);ctx.arcTo(x,y+h,x,y,rr);ctx.arcTo(x,y,x+w,y,rr);ctx.closePath();}
      function drawCell(col,row,color,text,alpha=1){const pad=Math.floor(cell*0.08);const x=gridX0+col*cell+pad;const y=row*cell+pad;const s=cell-pad*2;ctx.save();ctx.globalAlpha=alpha;ctx.fillStyle=color;roundRect(x,y,s,s,Math.floor(s*0.2));ctx.fill();ctx.fillStyle='rgba(255,255,255,.95)';ctx.font=`${Math.floor(s*0.5)}px ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial`;ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText(text,x+s/2,y+s/2+1*dpi);ctx.restore();}
      function drawGrid(){const gridW=cell*COLS,gridH=cell*ROWS;ctx.save();ctx.clearRect(0,0,cvs.width,cvs.height);
        ctx.beginPath();ctx.moveTo(gridX0-1,0);ctx.lineTo(gridX0-1,gridH);ctx.strokeStyle='rgba(255,255,255,.15)';ctx.lineWidth=2*dpi;ctx.stroke();
        ctx.beginPath();ctx.moveTo(gridX0+gridW+1,0);ctx.lineTo(gridX0+gridW+1,gridH);ctx.strokeStyle='rgba(255,255,255,.15)';ctx.lineWidth=2*dpi;ctx.stroke();
        for(let c=0;c<=COLS;c++){ctx.beginPath();const x=gridX0+c*cell;ctx.moveTo(x,0);ctx.lineTo(x,gridH);ctx.strokeStyle=(c%3===0)?'rgba(255,255,255,.18)':'rgba(255,255,255,.06)';ctx.lineWidth=(c%3===0)?2*dpi:1*dpi;ctx.stroke();}
        for(let r=0;r<=ROWS;r++){ctx.beginPath();ctx.moveTo(gridX0,r*cell);ctx.lineTo(gridX0+gridW,r*cell);ctx.strokeStyle='rgba(255,255,255,.06)';ctx.lineWidth=1*dpi;ctx.stroke();}
        ctx.restore();}
      function drawCodonBackgrounds(){for(let i=0;i<COLS;i+=3){const color=['#2563EB','#D97706','#059669','#7C3AED','#DC2626','#059669'][i/3%6];ctx.save();ctx.globalAlpha=.15;ctx.fillStyle=color;const x=gridX0+i*cell;const y=(ROWS-2)*cell;roundRect(x,y,3*cell,2*cell,8*dpi);ctx.fill();ctx.restore();}}
      function drawBonds(col){const top=placedTop[col];if(!top)return;const bot=bottomRow[col];const pair=new Set([top,bot]);const count=(pair.has('A')&&pair.has('T'))?2:3;const x=gridX0+col*cell+cell/2;const yTop=(ROWS-2)*cell+cell*0.85;const yBottom=(ROWS-1)*cell+cell*0.15;ctx.save();ctx.strokeStyle='rgba(255,255,255,.8)';ctx.lineWidth=Math.max(2*dpi,2);ctx.lineCap='round';const delta=cell*0.12;const offsets=count===2?[-delta,+delta]:[-delta,0,+delta];for(const dx of offsets){ctx.beginPath();ctx.moveTo(x+dx,yTop);ctx.lineTo(x+dx,yBottom);ctx.stroke();}ctx.restore();}
      function drawCodonLabels(){const gridH=cell*ROWS;const y=gridH+Math.floor(labelPx*0.62);ctx.save();ctx.textAlign='center';ctx.textBaseline='middle';
        for(let i=0;i<COLS;i+=3){const trip=(bottomRow[i]||'')+(bottomRow[i+1]||'')+(bottomRow[i+2]||'');const aa=CODON_TO_AA[trip]||'—';const cx=gridX0+(i+1.5)*cell;ctx.save();const color=['#2563EB','#D97706','#059669','#7C3AED','#DC2626','#059669'][i/3%6];const padY=7*dpi,w=3*cell-8*dpi;const x=gridX0+i*cell+4*dpi;const h=padY*2+Math.max(12*dpi,Math.floor(cell*0.35));ctx.globalAlpha=.25;ctx.fillStyle=color;roundRect(x,y-h/2,w,h,10*dpi);ctx.fill();ctx.globalAlpha=1;ctx.fillStyle='#fff';ctx.font=`${Math.max(11*dpi,Math.floor(cell*0.37))}px ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial`;ctx.fillText(aa,cx,y+1*dpi);ctx.restore();}ctx.restore();}

      // Left panel: AA history + live fraction "(X/N)"
      function drawAAChain(){
        const gridH=cell*ROWS; const topPad=Math.max(10*dpi,Math.floor(cell*.2)); const bottomPad=Math.max(6*dpi,Math.floor(cell*.15));
        const usableH=gridH-topPad-bottomPad; const rowsPerCol=ROWS_PER_COL; const colsNeeded=Math.min(MAX_AA_COLS,Math.max(1,Math.ceil(processedAA.length/rowsPerCol)));
        const rTop=Math.max(9*dpi,Math.floor(cell*.24)); const rBottom=Math.max(7*dpi,Math.floor(cell*.14));
        const stepY=usableH/rowsPerCol; const colGap=6*dpi; const colWidth=2*rTop+colGap;
        const panelCenterX=Math.floor(leftPanelPx/2); const totalW=colsNeeded*colWidth; const x0=Math.max(8*dpi, panelCenterX-Math.floor(totalW/2));
        ctx.save(); ctx.fillStyle='rgba(255,255,255,.7)';
        const titleSz=sideTitleSize();
        ctx.font=`${titleSz}px ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial`; ctx.textAlign='center'; ctx.textBaseline='top';
        ctx.fillText(`Completed Amino Acids (${processedAA.length}/${totalAAcount})`, panelCenterX, 4*dpi);
        const maxShow=rowsPerCol*MAX_AA_COLS; const n=Math.min(processedAA.length,maxShow);
        for(let j=0;j<n;j++){const letter=processedAA[j];const col=Math.floor(j/rowsPerCol);const row=j%rowsPerCol;const cx=x0+col*colWidth+rTop;const r=Math.floor(rBottom+(rTop-rBottom)*(1-row/(rowsPerCol-1)));const cy=topPad+row*stepY+stepY/2+10*dpi;ctx.beginPath();ctx.arc(cx,cy,r,0,Math.PI*2);ctx.fillStyle='rgba(255,255,255,.18)';ctx.fill();ctx.lineWidth=2*dpi;ctx.strokeStyle='rgba(255,255,255,.4)';ctx.stroke();ctx.fillStyle='#fff';ctx.font=`${Math.floor(r*.95)}px ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial`;ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText(letter,cx,cy+1*dpi);}
        ctx.restore();
      }

      // Right-side tutorial (4 cards: AT, CG, No stacking, Complete full row)
      function drawPairingGuide(){
        if(!showGuide) return;
        const gridW=cell*COLS,gridH=cell*ROWS;
        const x=gridX0+gridW+8*dpi;
        const w=Math.max(120*dpi, rightPanelPx-16*dpi);
        const y=10*dpi, h=gridH-20*dpi;
        ctx.save();
        ctx.globalAlpha=0.35; ctx.fillStyle='#000';
        roundRect(x,y,w,h,12*dpi); ctx.fill();
        ctx.globalAlpha=1;

        // Title: "Tutorial"
        ctx.fillStyle='#fff';
        const titleSz=sideTitleSize();
        ctx.font=`${titleSz}px ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial`;
        ctx.textAlign='center'; ctx.textBaseline='top';
        ctx.fillText('Tutorial', x+w/2, y+10*dpi);

        // Layout for 4 cards
        const gap = 22*dpi;
        const cardW=w-24*dpi;
        const count=4;
        const cardH=(h - titleSz - (gap+8*dpi)*count)/count;
        const cx=x+w/2;

        function pairCard(order, leftBase, rightBase, leftColor, rightColor, bonds, caption){
          const topY = y + 10*dpi + titleSz + order*(cardH+gap);
          ctx.globalAlpha=0.25; ctx.fillStyle='#111827';
          roundRect(x+12*dpi, topY, cardW, cardH, 10*dpi); ctx.fill();
          ctx.globalAlpha=1;

          const r = Math.min(28*dpi, Math.floor(cardH*0.24));
          const lx = cx - cardW/4, rx = cx + cardW/4;
          const cy = topY + cardH/2 - 6*dpi;

          ctx.fillStyle=leftColor;  ctx.beginPath(); ctx.arc(lx, cy, r, 0, Math.PI*2); ctx.fill();
          ctx.fillStyle=rightColor; ctx.beginPath(); ctx.arc(rx, cy, r, 0, Math.PI*2); ctx.fill();

          ctx.fillStyle='#fff';
          ctx.font=`${Math.floor(r*1.0)}px ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial`;
          ctx.textAlign='center'; ctx.textBaseline='middle';
          ctx.fillText(leftBase,  lx, cy+1*dpi);
          ctx.fillText(rightBase, rx, cy+1*dpi);

          // Bonds
          const delta = 10*dpi;
          const offsets = bonds===2 ? [-delta,+delta] : [-delta,0,+delta];
          ctx.strokeStyle='rgba(255,255,255,.9)'; ctx.lineWidth=2.5*dpi; ctx.lineCap='round';
          offsets.forEach(d=>{ ctx.beginPath(); ctx.moveTo(lx+r+6*dpi, cy+d); ctx.lineTo(rx-r-6*dpi, cy+d); ctx.stroke(); });

          // Caption
          ctx.fillStyle='rgba(255,255,255,.9)';
          ctx.font=`${Math.max(10*dpi, Math.floor(r*0.6))}px ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial`;
          ctx.fillText(caption, cx, cy + r + 16*dpi);
        }

        function noStackCard(order){
          const topY = y + 10*dpi + titleSz + order*(cardH+gap);
          ctx.globalAlpha=0.25; ctx.fillStyle='#111827';
          roundRect(x+12*dpi, topY, cardW, cardH, 10*dpi); ctx.fill();
          ctx.globalAlpha=1;

          const r = Math.min(20*dpi, Math.floor(cardH*0.18));
          const cy0 = topY + cardH/2 - r*1.4;
          const cx0 = cx;

          // Three stacked bases (A, T, G)
          const bases = ['A','T','G'];
          const colors= [COLORS.A, COLORS.T, COLORS.G];
          for(let i=0;i<3;i++){
            ctx.fillStyle=colors[i]; ctx.beginPath(); ctx.arc(cx0, cy0 + i*(r*1.6), r, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle='#fff'; ctx.font=`${Math.floor(r*.9)}px ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial`;
            ctx.textAlign='center'; ctx.textBaseline='middle';
            ctx.fillText(bases[i], cx0, cy0 + i*(r*1.6) + 1*dpi);
          }

          // Red "no" symbol
          const bigR = r*2.6;
          ctx.strokeStyle='rgba(239,68,68,0.95)';
          ctx.lineWidth = Math.max(4*dpi, r*0.35);
          ctx.beginPath(); ctx.arc(cx0, cy0 + r*1.6 - r*0.2, bigR, 0, Math.PI*2); ctx.stroke();
          ctx.beginPath(); ctx.moveTo(cx0 - bigR*0.7, cy0 + r*1.6 - r*0.2 - bigR*0.7);
          ctx.lineTo(cx0 + bigR*0.7, cy0 + r*1.6 - r*0.2 + bigR*0.7); ctx.stroke();

          // Caption
          ctx.fillStyle='rgba(255,255,255,.9)';
          ctx.font=`${Math.max(10*dpi, Math.floor(r*0.7))}px ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial`;
          ctx.textAlign='center'; ctx.textBaseline='top';
          ctx.fillText('No stacking — only pairs of two', cx, topY + cardH - (r*0.6) );
        }

        function completeRowCard(order){
          const topY = y + 10*dpi + titleSz + order*(cardH+gap);
          ctx.globalAlpha=0.25; ctx.fillStyle='#111827';
          roundRect(x+12*dpi, topY, cardW, cardH, 10*dpi); ctx.fill();
          ctx.globalAlpha=1;

          // Draw a mini 12-cell row with a checkmark
          const rowPad = 10*dpi;
          const miniCell = Math.max(10*dpi, Math.floor((cardW - 2*rowPad)/14)); // leave margins
          const startX = x + 12*dpi + rowPad;
          const yRow  = topY + cardH/2 - miniCell/2 - 6*dpi;

          for(let i=0;i<12;i++){
            const bx = startX + i*miniCell;
            ctx.fillStyle='rgba(255,255,255,0.08)';
            roundRect(bx, yRow, miniCell-2*dpi, miniCell-2*dpi, 4*dpi); ctx.fill();
          }

          // Big green check
          const cx0 = x + 12*dpi + cardW - 36*dpi;
          const cy0 = yRow + miniCell/2;
          ctx.strokeStyle='rgba(16,185,129,0.95)'; // emerald-500
          ctx.lineWidth = 5*dpi; ctx.lineCap='round';
          ctx.beginPath();
          ctx.moveTo(cx0-16*dpi, cy0);
          ctx.lineTo(cx0-6*dpi, cy0+12*dpi);
          ctx.lineTo(cx0+16*dpi, cy0-12*dpi);
          ctx.stroke();

          // Caption
          ctx.fillStyle='rgba(255,255,255,.9)';
          ctx.font=`${Math.max(10*dpi, Math.floor(miniCell*0.9))}px ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial`;
          ctx.textAlign='center'; ctx.textBaseline='top';
          ctx.fillText('Complete full row to translate', x + 12*dpi + cardW/2, topY + cardH - (miniCell*0.2) );
        }

        // Cards in order
        pairCard(0,'A','T',COLORS.A,COLORS.T,2, 'A pairs with T');
        pairCard(1,'C','G',COLORS.C,COLORS.G,3, 'C pairs with G');
        noStackCard(2);
        completeRowCard(3);

        ctx.restore();
      }

      function drawNextPreview(){const gridW=cell*COLS;const boxW=Math.floor(cell*2.0),boxH=Math.floor(cell*1.5);const x=gridX0+gridW-boxW-10*dpi;const y=10*dpi;ctx.save();ctx.globalAlpha=.85;ctx.fillStyle='rgba(0,0,0,.35)';roundRect(x,y,boxW,boxH,10*dpi);ctx.fill();ctx.globalAlpha=1;ctx.fillStyle='#fff';ctx.font=`${Math.floor(12*dpi)}px ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial`;ctx.textAlign='left';ctx.textBaseline='top';ctx.fillText('NEXT',x+10*dpi,y+8*dpi);const bx=x+boxW/2,by=y+boxH/2+4*dpi;const s=Math.floor(cell*.75);const color=COLORS[nextBase]||'#6B7280';ctx.textAlign='center';ctx.textBaseline='middle';roundRect(bx-s/2,by-s/2,s,s,8*dpi);ctx.fillStyle=color;ctx.fill();ctx.fillStyle='rgba(255,255,255,.95)';ctx.font=`${Math.floor(s*.48)}px ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial`;ctx.fillText(nextBase||'?',bx,by+1*dpi);const hint=COMPL[nextBase]||'?';ctx.fillStyle='rgba(255,255,255,.75)';ctx.font=`${Math.floor(s*.26)}px ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial`;ctx.fillText(`↕ ${hint}`,bx,by+s*.65);ctx.restore();}
      function aaListForRow(row){const out=[];for(let i=0;i<COLS;i+=3){const trip=(row[i]||'')+(row[i+1]||'')+(row[i+2]||'');const aa3=CODON_TO_AA[trip]||'X';out.push(AA3_TO_1[aa3]||'?');}return out;}

      function draw(){
        drawGrid(); drawCodonBackgrounds();
        for(let c=0;c<COLS;c++){const b=bottomRow[c];drawCell(c,TARGET_ROW,COLORS[b],b);}
        for(let c=0;c<COLS;c++){const p=placedTop[c];if(p){drawCell(c,BUILD_ROW,COLORS[p],p);drawBonds(c);}}
        if(running&&lives>0){const py=Math.min(piece.y,BUILD_ROW);drawCell(piece.x,Math.floor(py),COLORS[piece.base],piece.base,.95);}
        drawCodonLabels(); drawNextPreview(); drawAAChain(); drawPairingGuide();
      }

      /* logic */
      function canPlaceAt(x){return x>=0 && x<COLS;}
      function tryLock(){
        const x=piece.x; const target=bottomRow[x];
        const isCorrect=(target===COMPL[piece.base]) && !placedTop[x];
        if(isCorrect){
          placedTop[x]=piece.base; filledCount++; score+=10; updateHUD();
          if(filledCount===COLS){
            if(level===1){ showGuide=false; }
            score+=100; level++; fallInterval=Math.max(160,Math.floor(fallInterval*0.9)); pendingSpawn=true;
            const justRow=bottomRow.slice();
            rowComplete(()=>{ 
              const aaList=aaListForRow(justRow); 
              processedAA.push(...aaList); // <-- LIVE COUNTER UPDATES HERE
              seqIdx=(seqIdx+COLS)%masterSeq.length; 
              bottomRow=getSegment(seqIdx,COLS); 
              placedTop=Array(COLS).fill(null); 
              filledCount=0; 
              updateHUD(); 
              nextBase=pickValidBase(); 
              piece=spawnPiece(); 
              pendingSpawn=false; 
            });
            return;
          }
        }else{
          lives-=1; shake(); updateHUD(); if(lives<=0){ gameOver(); return; }
        }
        piece=spawnPiece();
      }

      function rowComplete(done){
        let start; const dur=350;
        function anim(ts){ if(!start) start=ts; const t=(ts-start)/dur; const alpha=Math.max(0,1-t);
          ctx.clearRect(0,0,cvs.width,cvs.height); drawGrid(); drawCodonBackgrounds();
          for(let c=0;c<COLS;c++){const b=bottomRow[c];drawCell(c,TARGET_ROW,COLORS[b],b,alpha);const p=placedTop[c];if(p)drawCell(c,BUILD_ROW,COLORS[p],p,alpha);}
          if(t<1) requestAnimationFrame(anim); else done();
        }
        requestAnimationFrame(anim);
      }

      function gameOver(){ running=false; overlay.style.display='flex'; ovTitle.textContent='Game Over'; ovSub.textContent='Press R to restart'; }
      function updateHUD(){
        scoreEl.textContent=`Score ${score}`;
        levelPill.textContent = `Level ${level}`;
        livesEl.textContent='❤❤❤'.slice(0,lives).padEnd(3,'☆');
        // (Completed Amino Acids counter is drawn in drawAAChain() every frame)
      }

      function step(ts){
        if(!running){ draw(); requestAnimationFrame(step); return; }
        if(!lastStep) lastStep=ts; const dt=ts-lastStep;
        if(dt>=fallInterval && !pendingSpawn){ piece.y+=1; lastStep=ts; if(piece.y>=BUILD_ROW) tryLock(); }
        draw(); requestAnimationFrame(step);
      }
      requestAnimationFrame(step);

      function move(dx){ const nx=piece.x+dx; if(canPlaceAt(nx)) piece.x=nx; }
      function softDrop(){ piece.y=Math.min(piece.y+1,BUILD_ROW); if(piece.y>=BUILD_ROW) tryLock(); }
      function hardDrop(){ piece.y=BUILD_ROW; tryLock(); }
      function togglePause(){ if(!hasStarted) return; running=!running; overlay.style.display=running?'none':'flex'; ovTitle.textContent=running?'':'Paused'; ovSub.textContent=running?'':'Press P to resume'; }
      function restart(){ 
        score=0; level=1; lives=3; fallInterval=560; lastStep=0; seqIdx=0; 
        bottomRow=getSegment(seqIdx,COLS); placedTop=Array(COLS).fill(null); filledCount=0; 
        processedAA=[]; 
        nextBase=pickValidBase(); piece=spawnPiece(); 
        running=true; overlay.style.display='none'; showGuide=true; 
        updateHUD(); draw(); 
      }
      function startGame(seq){ 
        masterSeq=sanitizeDNA(seq)||DEFAULT_SEQ; 
        totalAAcount=Math.floor(masterSeq.length/3); // <-- set total AA target from sequence length
        seqIdx=0; hasStarted=true; 
        restart(); 
      }

      // block page scroll for arrow/space unless typing in input
      window.addEventListener('keydown', (e)=>{
        const inText = document.activeElement && (document.activeElement.tagName==='INPUT' || document.activeElement.isContentEditable);
        if(inText) return;
        if(e.key==='ArrowDown' || e.key==='ArrowUp' || e.key===' '){ e.preventDefault(); }
      }, {passive:false});

      // gameplay keys
      window.addEventListener('keydown', e=>{
        if(e.repeat) return;
        const k=e.key;
        if(!running){
          if(k==='p'||k==='P'){ if(hasStarted) togglePause(); }
          else if(k==='r'||k==='R'){ if(hasStarted) restart(); }
          return;
        }
        if(k==='ArrowLeft'){ e.preventDefault(); move(-1); }
        else if(k==='ArrowRight'){ e.preventDefault(); move(1); }
        else if(k==='ArrowDown'){ e.preventDefault(); softDrop(); }
        else if(k===' '||k==='Spacebar'){ e.preventDefault(); hardDrop(); }
        else if(k==='p'||k==='P'){ togglePause(); }
        else if(k==='r'||k==='R'){ restart(); }
      }, {passive:false});

      // input validation + start actions
      function validateInput(){
        const raw=seqInput.value||''; const clean=sanitizeDNA(raw);
        if(raw!==clean){ const pos=seqInput.selectionStart; seqInput.value=clean.toLowerCase(); try{seqInput.setSelectionRange(Math.max(0,pos-1),Math.max(0,pos-1));}catch(_){ } }
        const ok=clean.length>=3;
        startBtn.disabled=!ok;
        seqInput.style.borderColor=ok?'#10B981':'#EF4444';
        msgEl.textContent=ok?`${clean.length} bases ✓ (min 12 recommended)`:'Only A/T/C/G • min 3 bases';
        msgEl.style.color=ok?'#10B981':'#EF4444';
      }
      validateInput();
      seqInput.addEventListener('input', validateInput);
      startBtn.addEventListener('click', ()=>{ if(!startBtn.disabled){ startGame(seqInput.value); cvs.focus && cvs.focus(); }});
      startCustomBtn.addEventListener('click', ()=>{ if(!startBtn.disabled){ startGame(seqInput.value); cvs.focus && cvs.focus(); }});
      seqInput.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); if(!startBtn.disabled){ startGame(seqInput.value); cvs.focus && cvs.focus(); } } });

      // Start with GFP
      startGfpBtn.addEventListener('click', ()=>{
        seqInput.value = DEFAULT_SEQ_LOWER;
        validateInput();
        startGame(DEFAULT_SEQ);
        cvs.focus && cvs.focus();
      });

      function shake(){ wrap.style.transition='transform 80ms'; wrap.style.transform='translateX(4px)'; setTimeout(()=>{ wrap.style.transform='translateX(-4px)'; },80); setTimeout(()=>{ wrap.style.transform='translateX(0)'; },160); }

      // init
      bottomRow=getSegment(seqIdx,COLS);
      resize();
    });
  }catch(err){
    console.error('[DNA Game] init error', err);
    const m=document.createElement('div');
    m.textContent='DNA game failed to load: '+(err&&err.message?err.message:err);
    m.style.color='red'; m.style.fontFamily='ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial';
    document.getElementById('dna-tetris-root')?.appendChild(m);
  }
})();
</script>
</body>
</html>
